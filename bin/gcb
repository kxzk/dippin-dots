#!/usr/bin/env bash
set -euo pipefail

main_branch="${1:-main}"
dry_run=false

if [[ "${2:-}" == "--dry-run" ]]; then
    dry_run=true
fi

git fetch --prune

local_merged=$(git branch --merged "$main_branch" | grep -v "^\*" | grep -v "$main_branch" | sed 's/^[ ]*//' || true)
remote_merged=$(git branch -r --merged "$main_branch" | grep -v "$main_branch" | grep -v "HEAD" | sed 's/^[ ]*origin\///' || true)

local_count=0
remote_count=0

if [[ -n "$local_merged" ]]; then
    echo "Local:"
    for branch in $local_merged; do
        if $dry_run; then
            echo "  [dry-run] $branch"
        else
            git branch -d "$branch"
            echo "  deleted $branch"
        fi
        ((local_count++))
    done
else
    echo "No local merged branches"
fi

echo ""

if [[ -n "$remote_merged" ]]; then
    echo "Remote:"
    for branch in $remote_merged; do
        if $dry_run; then
            echo "  [dry-run] origin/$branch"
        else
            git push origin --delete "$branch" 2>/dev/null && echo "  deleted origin/$branch" || echo "  skipped origin/$branch"
        fi
        ((remote_count++))
    done
else
    echo "No remote merged branches"
fi

echo ""
echo "Summary: $local_count local, $remote_count remote"

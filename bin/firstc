#!/bin/bash
# firstc - First Commit (creates initial commit from Linear branch)
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ -z $(git status --porcelain) ]]; then
    echo -e "${YELLOW}no changes to commit${NC}"
    exit 0
fi

echo -e "${YELLOW}❨ firstc | first-commit ❩${NC}"

BRANCH=$(git branch --show-current)

if [[ ! "$BRANCH" =~ ^feature/([a-zA-Z0-9]+-[0-9]+)-(.+)$ ]]; then
    echo -e "${RED}branch doesn't match pattern: feature/<issue>-<description>${NC}"
    echo -e "${RED}got: $BRANCH${NC}"
    exit 1
fi

ISSUE="${BASH_REMATCH[1]}"
DESC="${BASH_REMATCH[2]}"

ISSUE_UPPER=$(echo "$ISSUE" | tr '[:lower:]' '[:upper:]')

DESC_WORDS=$(echo "$DESC" | tr '-' ' ')
DESC_TITLE=$(echo "$DESC_WORDS" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')

COMMIT_MSG="[$ISSUE_UPPER] $DESC_TITLE"

echo -e "${GREEN}| staging${NC}"
git add -A

echo -e "${GREEN}| committing${NC}"
echo -e "${YELLOW}$COMMIT_MSG${NC}"
git commit -m "$COMMIT_MSG"

echo -e "${GREEN}| pushing${NC}"
git push -u origin "$BRANCH"

echo -e "${GREEN}| ✓${NC}"

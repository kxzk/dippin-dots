#!/bin/bash
# ac - Git Commit with Claude Code (auto-commit)
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
GRAY='\033[38;5;8m'
NC='\033[0m'

# Exit early if nothing to commit
if [[ -z $(git status --porcelain) ]]; then
    echo -e "${GRAY}no changes to commit${NC}"
    exit 0
fi

echo -e "${GRAY}❨ ac | auto-committer ❩${NC}"

git add -A

TEMP_MSG=$(mktemp)

# Generate commit message (title only)
{
    echo "Generate a single-line conventional commit message."
    echo ""
    echo "Format: type(scope): imperative description"
    echo ""
    echo "Changes:"
    echo "---"
    git status --short
    echo "---"
    git diff --cached --stat
    echo "---"
    git diff --cached | head -300
    echo "---"
    echo "Rules:"
    echo "• Types: feat|fix|docs|refactor|perf|test|chore"
    echo "• Lowercase, no period, imperative mood"
    echo "• Under 50 chars total"
    echo ""
    echo "Output ONLY the raw commit line. No backticks, no code fences, no body, no explanation."
} | claude -p --model claude-haiku-4-5-20251001 > "$TEMP_MSG"

if [[ ! -s "$TEMP_MSG" ]]; then
    echo -e "${RED}failed to generate commit message${NC}"
    rm "$TEMP_MSG"
    exit 1
fi

git commit -F "$TEMP_MSG"
rm "$TEMP_MSG"

git push 2>/dev/null || git push -u origin "$(git branch --show-current)"

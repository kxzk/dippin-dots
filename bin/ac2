#!/bin/bash
# ac2 - Git Commit with Cursor Agent (auto-commit)
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
GRAY='\033[38;5;8m'
NC='\033[0m'

# Exit early if nothing to commit
if [[ -z $(git status --porcelain) ]]; then
    echo -e "${GRAY}no changes to commit${NC}"
    exit 0
fi

echo -e "${GRAY}❨ ac2 | cursor auto-committer ❩${NC}"

git add -A

TEMP_MSG=$(mktemp)

# Generate commit message with structured prompt
{
    echo "Create a conventional commit message with this exact structure:"
    echo ""
    echo "type(scope): imperative subject under 50 chars"
    echo ""
    echo "- Bullet point explaining WHY this change matters"
    echo "- Bullet point for each significant change"
    echo "- Focus on user/system impact, not implementation"
    echo ""
    echo "Changes to analyze:"
    echo "---"
    git status --short
    echo "---"
    git diff --cached --stat
    echo "---"
    git diff --cached | head -300
    echo "---"
    echo "Rules:"
    echo "• Types: feat|fix|docs|refactor|perf|test|chore"
    echo "• Subject: lowercase, no period, imperative mood"
    echo "• Body: blank line after subject, bullets wrapped at 72 chars"
    echo "• Skip obvious details—explain context and impact"
    echo ""
    echo "Output ONLY the raw commit message. No markdown, no code blocks, no \`\`\`, no explanations."
} | agent -p --model composer-1 --output-format text > "$TEMP_MSG"

if [[ ! -s "$TEMP_MSG" ]]; then
    echo -e "${RED}failed to generate commit message${NC}"
    rm "$TEMP_MSG"
    exit 1
fi

git commit -F "$TEMP_MSG"
rm "$TEMP_MSG"

git push 2>/dev/null || git push -u origin "$(git branch --show-current)"
